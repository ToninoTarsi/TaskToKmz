<html>
   <head>
		<title>TaskToKmz</title>
		
		<style>
 			.ajax_loader {background: url("img/spinner_squares_circle.gif") no-repeat bottom center  transparent;width:100%;height:100%;}
			.blue-loader .ajax_loader {background: url("img/ajax-loader_blue.gif") no-repeat center center transparent;}
		</style>
		
		
		<link rel="stylesheet" href="css/jquery.multiselect.css" />
		<link rel="stylesheet" href="css/ui-darkness/jquery-ui-1.10.3.custom.min.css" />

		
		
		<script src="https://www.google.com/jsapi"> </script> 
		<script src="http://earth-api-samples.googlecode.com/svn/trunk/lib/kmldomwalk.js" type="text/javascript"> </script>

		<script src="js/jquery-1.9.1.js"></script>
		<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
		<script src="js/jquery.multiselect.min.js"></script>
		<script id="loader" src="js/ajax-loader.js" type="text/javascript"></script>
		
		<script type="text/javascript">
			$.urlParam = function(name){
			    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
			    return results[1] || 0;
			}
			$(function(){
	      		box1 = new ajaxLoader($("#controls"));
			});
		</script>


      <script type="text/javascript">

      	
      
         var href = $.urlParam('kmz'); // name
         var namearr = href.split("/");
         name = namearr[namearr.length -1 ]
         document.title = name.split(".")[0];
//       	 if ( href == null ) {
//       		 alert("kmz not defined. Usage : ViewTask.html?kmz=fullurl.kmz");
//       		 return;
//       	 } 
      	 //var href = 'http://www.vololiberomontecucco.it/TaskToKmz/trofeo2013_task1.kmz';
         //var href = 'http://www.vololiberomontecucco.it/docs/05082013.kmz';
         
         var box1;
         var ge;
         var tour;
         var tours = new Array();
         var placemarks = new Array();
         
         google.load("earth", "1");

         function init() {
            google.earth.createInstance('map3d', initCB, failureCB);
         }

         function initCB(instance) {
            ge = instance;
            ge.getWindow().setVisibility(true);
            ge.getNavigationControl().setVisibility(ge.VISIBILITY_SHOW);

            
            enterTour();
         }

         function failureCB(errorCode) {
         }

         function addPilot(i,pilotName,checked) {
        	 //alert(tour.getName());
        	 var pilotsActive =document.getElementById("pilotsActive");

        
	         var option1=document.createElement("option");

	
	         option1.text= pilotName;
	         option1.value = i;
	         option1.selected = checked;
	         try {
	           // for IE earlier than version 8
	           pilotsActive.add(option1,pilotsActive.options[null]);

	         } catch (e) {
	        	 pilotsActive.add(option1,null);

	         }
         }
         
         function addTour(i,pilotName) {
        	 //alert(tour.getName());
        	 var pilotSelect =document.getElementById("pilotToFollow");

 
	         var option=document.createElement("option");

	         option.text= pilotName;
	         option.value = i;
	         try {
	           // for IE earlier than version 8
	           pilotSelect.add(option,pilotSelect.options[null]);

	         } catch (e) {
	        	 pilotSelect.add(option,null);

	         }
         }
         
         // Tour control functions.
         function enterTour() {
        	 

             google.earth.fetchKml(ge, href, fetchCallback);

             function fetchCallback(fetchedKml) {
                // Alert if no KML was found at the specified URL.
                if (!fetchedKml) {
                   setTimeout(function() {
                      alert('Bad or null KML');
                   }, 0);
                   return;
                }

                // Add the fetched KML into this Earth instance.
                ge.getFeatures().appendChild(fetchedKml);

                // Walk through the KML to find the tour object; assign to variable 'tour.'
                var i = 0;
                var k = 0;
                walkKmlDom(fetchedKml, function() {
                   //alert(this.getType());
                   if (this.getType() == 'KmlTour') {
                      tour = this;
                      tours[i] = this;
                      addTour(i,tour.getName());
                      i++;
                      //return false;
                   }
                   if (this.getType() == 'KmlPlacemark') {
                       placemarks[k] = this;
                       addPilot(k,this.getName(),this.getVisibility());
                       k++;
                       //return false;
                    }
                   
                });
                document.getElementById("playButton").disabled = false; 
                ge.getTourPlayer().setTour(tours[0]);
                
                $("#pilotsActive").multiselect({
                	   click: function(event, ui){
                		   		//alert(ui.value + ' ' + (ui.checked ? 'checked' : 'unchecked') );
                		   		if ( ui.checked ) 
                		   		  placemarks[ui.value].setVisibility(true);
                		   		else
                  		   		  placemarks[ui.value].setVisibility(false);

                		   },
                		   beforeopen: function(){
                		      //alert("Select about to be opened...");
                		   },
                		   open: function(){
                			   //alert("Select opened!");
                		   },
                		   beforeclose: function(){
                			   //alert("Select about to be closed...");
                		   },
                		   close: function(){
                			   //alert("Select closed!");
                		   },
                		   checkAll: function(){
                			   for (var i = 0; i < placemarks.length; i++) {
                				   placemarks[i].setVisibility(true);
                				}
                		   },
                		   uncheckAll: function(){
                			   for (var i = 0; i < placemarks.length; i++) {
                				   placemarks[i].setVisibility(false);
                				}
                		   },
                		   optgrouptoggle: function(event, ui){
                		      var values = $.map(ui.inputs, function(checkbox){
                		         return checkbox.value;
                		      }).join(", ");
                		      
                		      alert("Checkboxes " + (ui.checked ? "checked" : "unchecked") + ": " + values);
                		   }
                		});
                
                $("#pilotToFollow").multiselect({
                	   multiple: false,
                	   header: "Select a Pilot",
                	   noneSelectedText: "Select a Pilot",
                	   selectedList: 1
                	});
                
                //$("#playButton").button()
                
                $( "#playButton" ).button({
					icons: {
					primary: "ui-icon-play"
					},
					text: false 
				});
                
                $( "#pauseButton" ).button({
					icons: {
					primary: "ui-icon-pause"
					},
					text: false 
				});                
                
                
                

                $("#playButton").show();
                $("#pauseButton").show();

                
                $("#message").text("Select Pilot to follow: ");
                
                box1.remove();
                //$("#loader").hide();

             }
         }
         
         function playTour() {
            ge.getTourPlayer().play();
         }
         function pauseTour() {
            ge.getTourPlayer().pause();
         }
         
         function resetTour() {
            ge.getTourPlayer().reset();
         }
         function exitTour() {
            ge.getTourPlayer().setTour(null);
         }

         function pilotChanged(){
        	  var myselect = document.getElementById("pilotToFollow");
        	  var pilotID = myselect.options[myselect.selectedIndex].value;
        	  
        	  var currentTime = ge.getTourPlayer().getCurrentTime();
        	  var oldDuration = ge.getTourPlayer().getDuration()
        	  
        	  ge.getTourPlayer().setTour(tours[pilotID]);
        	  
        	  var newDuration = ge.getTourPlayer().getDuration()
        	  
        	  ge.getTourPlayer().setCurrentTime(currentTime * oldDuration / newDuration);
        	  
        	  ge.getTourPlayer().play();
        	}
         
         google.setOnLoadCallback(init);
         

         
         
      </script>
      
      
      <script type="text/javascript">
      
      
      
      </script>
   </head>
   <body>
   	<div id ="app" style="background-color:black;color:white;font-size: 85%;"> 
     <div id ="controls"  >
     	 <button style = "display:none" id="playButton" onclick="playTour()" value="Start" >  </button>
     	 <button style = "display:none" id="pauseButton"  onclick="pauseTour()" value="Pause"> </button>
     	
        <label id="message">Loading ... Please wait </label><select style = "display:none" id="pilotToFollow" onchange="pilotChanged()"> </select>
         
		<select style = "display:none" id="pilotsActive" multiple="multiple" >		</select>      
		   

      </div>
      <hr>
      <div id="map3d" style="height: 85%; width: 100%;"></div>
 		
 	 <div id="footer" >
 	 <p>Realized with TaskToKmz  - Source Code available @ <a href="https://github.com/ToninoTarsi/TaskToKmz">https://github.com/ToninoTarsi/TaskToKmz</a>  </p>
 	 
 	 </div>
 	 
 	  
	</div>
   </body>
</html>